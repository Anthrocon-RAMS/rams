{% extends "base.html" %}{% set admin_area=True %}
{% import "forms/macros.html" as form_macros with context %}
{% import "forms/attendee.html" as attendee_fields with context %}
{% block title %}Attendee Form - {{ attendee.full_name }}{% endblock %}
{% block content %}
{% include "check_in.html" %}

{% include "registration/menu.html" %}

<div class="row mb-3">
    <div class="col">
    {% if not attendee.is_new %}
    <a class="btn btn-primary" href="../preregistration/confirm?id={{ attendee.id }}" target="_blank">View as Attendee</a>
    {% endif %}
    {% if attendee.group and c.HAS_GROUP_ADMIN_ACCESS %}
        <a class="btn btn-secondary" href="../group_admin/form?id={{ attendee.group.id }}" target="_blank">View Group "{{ attendee.group.name }}"</a>
    {% endif %}
    {% if attendee.promo_code_groups %}
        <a class="btn btn-outline-secondary" href="../registration/promo_code_group_form?id={{ attendee.promo_code_groups[0].id }}" target="_blank">View Group "{{ attendee.promo_code_groups[0].name }}"</a>
    {% endif %}
    {% if not attendee.is_new %}
        <form method="post" class="d-inline" id="delete_attendee" action="delete" onSubmit="return confirm('{% if attendee.group and attendee.is_unassigned %}Are you sure you want to delete this unassigned badge?{% elif attendee.group %}Are you sure you want to unassign this badge?{% else %}Are you sure you want to delete this attendee?{% endif %}');">
            {{ csrf_token() }}
            <input type="hidden" name="id" value="{{ attendee.id }}" />
            {% if return_to %}<input type="hidden" name="return_to" value="{{ return_to }}" />{% endif %}
        </form>
        <input type="submit" form="delete_attendee" class="btn btn-danger" value="{% if attendee.group and attendee.is_unassigned %}Delete this group badge{% elif attendee.group %}Unassign this group badge{% else %}Delete Attendee{% endif %}"
                        {% if attendee.cannot_delete_badge_reason %} style="background-color:#BCBCBC" title="{{ attendee.cannot_delete_badge_reason }}" disabled {% endif %}/>
        {% if c.HAS_SECURITY_ADMIN_ACCESS %}
        <a href="../security_admin/watchlist_form?attendee_id={{ attendee.id }}" class="btn btn-warning">Add to Watchlist</a>
        {% endif %}

        {% if attendee.paid != c.LOST_BADGE %}
            <form method="post" class="d-inline" action="lost_badge">
                <input type="hidden" name="id" value="{{ attendee.id }}" />
                <input type="submit" class="btn btn-outline-danger" value="Report Lost Badge">
            </form>
        {% endif %}
{% endif %}
    </div>
    <div class="col text-end">
        <button type="submit" form="attendee-form" name="save_return_to_search" class="btn btn-primary" value="1">Save & Return{% if not return_to %} to Search{% endif %}</button>
        <button type="submit" form="attendee-form" name="save" class="btn btn-primary" value="1">Save</button>
        {% if c.AT_THE_CON and not attendee.checked_in and not attendee.is_not_ready_to_checkin and (not receipt or not receipt.current_amount_owed) %}
        <button class="btn btn-success" form="attendee-form" name="save_check_in" value="1">Save & Check In</button>
        {% endif %}
    </div>
</div>

<div class="card">
<div class="card-body">
{% if c.AT_THE_CON and receipt and receipt.current_amount_owed and not attendee.is_new %}
    <div class="alert alert-warning center" role="alert">
    <h4>{{ attendee.full_name }} currently owes <strong>{{ (receipt.current_amount_owed / 100)|format_currency }}</strong>.</h4>
    {% if payment_enabled %}
    {{ stripe_form('manual_reg_charge', attendee) }}
    {% else %}
    Please instruct them to pay at an at-door or manager station.
    {% endif %}
    </div>
    <iframe id="stripe_frame" name="stripe_frame" style="display:none"></iframe>
    <script type="text/javascript">
    $("form[action='manual_reg_charge']").prop('target', 'stripe_frame');
    $('#stripe_frame').load(function() {
        var responseText = $(this.contentDocument.body).text().trim();
        this.contentDocument.body.innerHTML = '';
        
        if (responseText) {
            hideMessageBox();
            var response = $.parseJSON(responseText);
            if (response['success'] == true) {
                window.location.href = '../registration/form?id={{ attendee.id }}&message=' + response['message'];
            } else {
                showErrorMessage('', response['message'], {timeOut: 1000});
            }
        }
    });
    </script>
{% endif %}
{% if receipt and receipt.current_amount_owed < 0 %}
<div class="alert alert-warning center" role="alert">
    We currently owe {{ attendee.full_name }} {{ (receipt.current_amount_owed / 100)|format_currency(true) }}.
    {% if c.HAS_REG_ADMIN_ACCESS %}Please view and correct their receipt <a href="../reg_admin/receipt_items">on their receipt page</a>.
    {% else %}Please ask an admin with receipt access to correct their receipt.{% endif %}
</div>
{% endif %}
{% if c.AT_THE_CON %}
{% include 'registration/attendee_pending_warning.html' %}
{% endif %}
{% include 'badge_printing/queue_badge.html' %}

{% if attendee.regdesk_info %}
<div class="alert alert-info">
    <div class="form-text">Special Instructions</div>
    <div class="mb-3">
        <strong>{{ attendee.regdesk_info }}</strong>
        <p class="form-text"><em>You can update these instructions below.</em></p>
    </div>
</div>
{% endif %}

{{ form_macros.form_validation('attendee-form') }}

<form novalidate method="post" id="attendee-form" action="form">
{{ csrf_token() }}
<input type="hidden" name="id" value="{{ attendee.db_id }}" />
<input type="hidden" name="return_to" value="{{ return_to }}" />

<div class="row">
<div id="attendee-form-nav" class="col-12 col-lg-2">
    <ul id="attendee-form-nav" class="nav flex-lg-column nav-pills sticky-lg-top pt-lg-3 mb-3">
        <li class="nav-item">
            <a class="nav-link border border-primary rounded active" href="#badge_flags">Badge Info</a>
        </li>&nbsp;
        <li class="nav-item">
            <a class="nav-link border border-primary rounded" href="#personal_info">Personal Info</a>
        </li>&nbsp;
        <li class="nav-item">
            <a class="nav-link border border-primary rounded" href="#badge_extras">Badge Extras</a>
        </li>&nbsp;
        <li class="nav-item">
            <a class="nav-link border border-primary rounded" href="#staffing_info">Staffing Info</a>
        </li>&nbsp;
        <li class="nav-item">
            <a class="nav-link border border-primary rounded" href="#other_info">Other Info</a>
        </li>
    </ul>
    <script type="text/javascript">
        $().ready(function() {
            $('#attendee-form-nav').find('.nav-link').click(function() {
                $(this).parents('#attendee-form-nav').find('.nav-link').removeClass('active');
                $(this).addClass('active');
            })
        });
    </script>
</div>
<div class="col-12 col-lg-10">
<a id="badge_flags"></a>
{% include "forms/attendee/badge_flags.html" %}
{% if not attendee.is_new %}
<button type="submit" class="btn btn-primary" value="Upload">Save</button>
{% endif %}
<hr/>
<a id="personal_info"></a>
{% include "forms/attendee/personal_info.html" %}
{% include "forms/attendee/other_info.html" %}
<button type="submit" class="btn btn-primary" value="Upload">Save</button>
<hr/>
<a id="badge_extras"></a>
{% include "forms/attendee/admin_badge_extras.html" %}
<button type="submit" class="btn btn-primary" value="Upload">Save</button>
<hr/>
<a id="staffing_info"></a>
{% include "forms/attendee/admin_staffing_info.html" %}
<button type="submit" class="btn btn-primary" value="Upload">Save</button>
<hr/>
<a id="other_info"></a>
{% include "forms/attendee/admin_consents.html" %}
{% include "forms/attendee/badge_admin_notes.html" %}

<div class="row g-sm-3">
    <div class="col">
        <button type="submit" name="save_return_to_search" class="btn btn-primary" value="1">Save & Return{% if not return_to %} to Search{% endif %}</button>
        <button type="submit" name="save" class="btn btn-primary" value="1">Save</button>
        {% if c.AT_THE_CON and not attendee.checked_in and not attendee.is_not_ready_to_checkin and (not receipt or not receipt.current_amount_owed) %}
        <button class="btn btn-success" name="save_check_in" value="1">Save & Check In</button>
        {% endif %}
    </div>
</div>

</form>
</div>
</div>
</div>
</div>
{% endblock %}
