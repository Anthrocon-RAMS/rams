{% import 'macros.html' as macros with context %}
{% import 'forms/macros.html' as form_macros with context %}
{% set personal_info = personal_info or forms['personal_info'] %}
{% set other_info = other_info or forms['other_info'] if 'other_info' in forms else None %}

{# BLOCK NAMES in this form:
      name
      contact_info
      age
      address
      ec_info

  Use these to add or rearrange fields. Remember to use {{ super() }} to print the original fields as-is.
#}

{% block name %}
{% set name_read_only = name_ro or (page_ro and not (limited_write or contact_write)) %}
{% set attendee_last_name = attendee.last_name[0] ~ '.' if limited_read else attendee.last_name %}

<div class="row g-sm-3">
<div class="col-12 col-sm-6">{{ form_macros.form_input(personal_info.first_name, readonly=name_read_only) }}</div>
<div class="col-12 col-sm-6">{{ form_macros.form_input(personal_info.last_name, value=attendee_last_name, readonly=name_read_only) }}</div>
</div>

{% if attendee.legal_name or attendee.is_new or attendee.placeholder %}
<div class="row g-sm-3">
  <div class="col-12 col-sm-6">{{ form_macros.toggle_checkbox(personal_info.same_legal_name, [personal_info.legal_name], toggle_required=True, hide_on_checked=True, prop="disabled",
                   disabled=name_read_only, checked=same_legal_name or attendee.first_name != '' and attendee.legal_name == '') }}
  </div>

  <div class="col-12 col-sm-6">{{ form_macros.form_input(personal_info.legal_name, help_text=macros.popup_link("../static_views/legal_name.html", 'What does "Legal Photo ID" mean?'),
              readonly=name_read_only) }}
  </div>
</div>
{% endif %}
{% endblock %}


{% block contact_info %}
{% set attendee_email = attendee.masked_email if limited_read else attendee.email %}
{% if is_prereg_dealer %}
  {% set email_extra_field = form_macros.toggle_checkbox(personal_info.copy_email, [personal_info.email], hide_on_checked=True, toggle_required=True, prop="disabled", checked=not personal_info.email.data and (edit_id or loaded_from_group)) %}
  {% set cellphone_extra_field = form_macros.toggle_checkbox(personal_info.copy_phone, [personal_info.cellphone], hide_on_checked=True, toggle_required=True, prop="disabled", checked=not personal_info.cellphone.data and (edit_id or loaded_from_group)) %}
{% elif attendee.staffing or (other_info and other_info is not none) %}
  {% set cellphone_extra_field = form_macros.toggle_checkbox(personal_info.no_cellphone, [personal_info.cellphone], hide_on_checked=True, prop="disabled") %}
{% endif %}

<div class="row g-sm-3">
  <div class="col-12 col-sm-6">
    {{ form_macros.form_input(personal_info.email, extra_field=email_extra_field, value=attendee_email, readonly=email_ro or (page_ro and not contact_write)) }}
  </div>

  <div class="col-12 col-sm-6">
    {{ form_macros.form_input(personal_info.cellphone, extra_field=cellphone_extra_field, readonly=cellphone_ro or (page_ro and not contact_write)) }}
  </div>
</div>
{% endblock %}


{% block age %}
<div class="row g-sm-3">
  <div class="col-12 col-sm-6">
{% if c.COLLECT_EXACT_BIRTHDATE %}
  {{ form_macros.form_input(personal_info.birthdate, readonly=age_ro or page_ro)}}
{% else %}
  TBD
{% endif %}
  </div>

  <div class="col-12 col-sm-6">
    {% if c.CONSENT_FORM_URL and not admin_area %}
    <div class="alert alert-warning" role="alert">
      <em>
        Attendees under 18 <b>MUST</b> bring a signed (and notarized if not accompanied by parent or guardian during badge pickup) 
        <a class="link-dark" target="_blank" href="{{ c.CONSENT_FORM_URL }}">parental consent form</a>.
      </em>
    </div>
    {% elif admin_area and attendee.birthdate %}
      ({{ attendee.age_group_conf.desc }})
    {% endif %}
  </div>
</div>
{% endblock %}


{% block address %}
{% if c.COLLECT_FULL_ADDRESS %}
{% if is_prereg_dealer %}
<div class="row g-sm-3">
  <div class="col-12">
    {{ form_macros.toggle_checkbox(personal_info.copy_address, 
      [personal_info.address1, personal_info.address2, personal_info.city, personal_info.region_us, 
      personal_info.region_canada, personal_info.region, personal_info.zip_code, personal_info.country], 
      hide_on_checked=True, toggle_required=True, prop="disabled", checked=not personal_info.address1.data and (edit_id or loaded_from_group)) }}
  </div>
</div>
<script type="text/javascript">
  // selectToAutocomplete is a pain in my ass
  $("#copy_address").on('click', function() {
    setTimeout(function() {
      $("#country-selectToAutocomplete").prop('disabled', $("#country").prop("disabled"));
    }, 10);
  })
  $().ready(function() { 
    setTimeout(function() {
      $("country-selectToAutocomplete").prop('disabled', $("#country").prop("disabled"));
    }, 10);
   }) 
</script>
{% endif %}
  {{ form_macros.address_fields(attendee, personal_info) }}
{% else %}
<div class="row g-sm-3">
  <div class="col-12 col-sm-6">
    {{ form_macros.form_input(personal_info.zip_code, extra_field=form_macros.form_input(personal_info.international, disabled=address_ro or page_ro), readonly=address_ro or page_ro)}}
  </div>

  <div class="col-12 col-sm-6">
  </div>
</div>
{% endif %}
{% endblock %}


{% block ec_info %}
{% set show_ec = admin_area and (full_read or c.HAS_REG_ADMIN_ACCESS or c.HAS_SECURITY_ADMIN_ACCESS) or (attendee.is_new or not admin_area) %}
{% if show_ec or not personal_info.ec_name.data %}
{% set onsite_extra_field = form_macros.toggle_checkbox(personal_info.no_onsite_contact, [personal_info.onsite_contact], toggle_required=True, hide_on_checked=True, prop="disabled") %}
<div class="row g-sm-3">
  <div class="col-12 col-sm-6">
    {{ form_macros.form_input(personal_info.ec_name, readonly=emergency_contact_ro or page_ro) }}
  </div>

  <div class="col-12 col-sm-6">
    {{ form_macros.form_input(personal_info.ec_phone, readonly=emergency_contact_ro or page_ro) }}
  </div>
</div>
{% endif %}
{% if show_ec or not personal_info.onsite_contact.data %}
<div class="row g-sm-3">
  <div class="col-12 col-sm-6">
    {{ form_macros.form_input(personal_info.onsite_contact, extra_field=onsite_extra_field, readonly=emergency_contact_ro or page_ro, maxlength="500") }}
  </div>
  <div class="col-12 col-sm-6">
    <div class="alert alert-info" role="alert">
    Please provide names and contact info for a trusted friend or friends who will be at or near the venue during the event.
    </div>
  </div>
</div>
{% endif %}
{% endblock %}