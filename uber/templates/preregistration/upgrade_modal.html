{{ stripe_form('process_attendee_payment', attendee, receipt_id=receipt.id, stripe_button_id="upgrade-stripe-btn") }}
<div class="modal fade" id="upgradeModal" tabindex="-1" role="dialog" aria-labelledby="upgradeTitle">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <span class="h4 modal-title" id="upgradeTitle">Add Upgrades</span>
        </div>
        <div class="modal-body">
            <form method="post" action="purchase_upgrades" id="purchase-upgrades" class="form-horizontal">
                {{ csrf_token() }}
                <input type="hidden" name="id" value="{{ attendee.id }}" />
                <input type="hidden" id="upgrade_badge_type" name="badge_type" value="{{ attendee.badge_type }}" />
                <input type="hidden" name="receipt_id" value="{{ receipt.id }}" />
                {{ attendee_fields.badge_buttons }}
                {{ attendee_fields.amount_extra(read_only=False, form="purchase-upgrades") }}
                {{ attendee_fields.badge_printed_name }}
                {{ attendee_fields.shirt_size }}
                {{ attendee_fields.extra_donation(read_only=False) }}
            </form>
            <table class="table table-striped" id="upgrade-preview">
                <tbody></tbody>
            </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
          <button type="submit" id="upgrade-purchase" form="purchase-upgrades" type="button" class="btn btn-success">Purchase<span id="upgrade-preview-total"></span></button>
        </div>
      </div>
    </div>
</div>

<script type="text/javascript">
    var costChangeDict = {};
    var lastAmountExtra; // I hate JavaScript
    var updateReceiptPreview = function(colName, val=0) {
        if (colName == 'amount_extra' && lastAmountExtra !== undefined && val == lastAmountExtra) {
            return;
        } else if (colName == 'amount_extra') {
            lastAmountExtra = val;
        }

        if (colName == "") {
            return;
        } else if (val == "") {
            val = 0;
        }
        var existing_row = $('td#' + colName + ' > span');
        $.post("get_receipt_preview", {
            csrf_token: csrf_token,
            id: "{{ attendee.id }}",
            col_name: colName,
            val: val
        },
        function(result) {
          if (result.error) {
            $("#message-alert").addClass("alert-danger").show().children('span').html(result.error);
          } else {
            change_str = result.change > 0 ? "$" + result.change / 100 : "-$" + result.change * -1 / 100;
            costChangeDict[colName] = result.change;
            if (result.change == 0) {
                if (existing_row.length) {
                    existing_row.parents('tr').remove();
                }
            } else if (existing_row.length) {
                existing_row.text(result.desc + ": " + change_str);
            } else {
                new_row = "<tr><td id='" + colName + "'>" +
                    "<span class='pull-right'>" + result.desc + ": " + change_str +
                    "</span></td></tr>";
                $('#upgrade-preview > tbody:last-child').append(new_row);
            }

            var upgradePreviewTotal = 0;
            for (var col in costChangeDict) {
                upgradePreviewTotal += costChangeDict[col];
            }
            if (upgradePreviewTotal > 0) {
                $('#upgrade-purchase').prop('disabled', false);
                $('#upgrade-preview-total').text(' for $' + upgradePreviewTotal / 100);
            } else {
                $('#upgrade-purchase').prop('disabled', true);
                $('#upgrade-preview-total').text('');
            }
          }
        });
    };
    $().ready(function() {
        $('#upgrade-purchase').prop('disabled', true);
        $("form[action='purchase_upgrades']").submit(function(event){
        var $form = $(this);
        $btn = $form.find('button[type=submit]');
        event.preventDefault();
        $btn.prop('disabled', true);
        $.post('purchase_upgrades', $form.serialize(), function(result) {
            $btn.prop('disabled', false);
            if (result.error) {
                $("#message-alert").addClass("alert-danger").show().children('span').html(result.error);
            } else if (result.success) {
                $('#upgradeModal').modal('toggle');
                callStripeAction(autoTrigger=true);
            }
        });
        });

        // Hide upgrade buttons for badge type and amount extra if there's nothing to upgrade to
        if (_(BADGE_TYPES.options).size() == 1) {
            $('#upgrade-badge-type-btn').hide();
        }
        if($('input:radio[name=amount_extra]').size() == 1) {
            $('#upgrade-amount-extra-btn').hide();
        }

        // Always hide the button we use for the upgrade modal
        $("#upgrade-stripe-btn").hide();
    });
</script>