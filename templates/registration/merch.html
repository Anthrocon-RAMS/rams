{% extends "base.html" %}
{% block title %}Merch Booth{% endblock %}
{% block content %}

<script type="text/javascript">
    function recordSale() {
        $.post("record_sale", {
                id:      "None",
                what:    $("#what_select").val() || $("#what_text").val() || "",
                cash:    $("#store_cash").val(),
                mpoints: $("#store_mpoints").val()
            }, function(json) {
                $("#message").html(json.message);
                if( json.success ) {
                    $("#message").append(' &nbsp; <a href="#" onClick="undoSale(' + json.id + ') ; return false">Undo</a>');
                }
            }, "json");
    }
    function undoSale(id) {
        $.post("undo_sale", {"id": id}, function(message) {
            $("#message").html(message);
        });
    }
    function showOrHideWhatText(page_loading) {
        $("#store_mpoints").val("0");
        if( $("#what_select").val() == "" ) {
            $("#what_text").show().focus();
            $("#store_cash").val("");
        }
        else {
            var prices = {{ STORE_PRICES|safe }};
            $("#what_text").val("").hide();
            $("#store_cash").val( prices[$("#what_select").val()] );
            if( !page_loading )
                $("#store_amount").focus();
        }
    }
    
    function giveMerch() {
        $.post("give_merch", {badge_num: $("#badge_num").val()}, function(json) {
            $("#badge_num").val("");
            $("#message").html(json.message);
            if( json.success ) {
                $("#message").append(' &nbsp; <a href="#" onClick="takeBackMerch(' + json.badge_num + ') ; return false">Undo</a>');
            }
        }, "json");
    }
    function takeBackMerch(badge_num) {
        $.post("take_back_merch", {badge_num: badge_num}, function(message) {
            $("#message").html(message);
        });
    }
    
    $(function(){
        $("#message").ajaxError(function(){
            showTop("Oh noes - the web server is down or something!!!!!");
        });
        
        showOrHideWhatText(true);
        $("#what_text,#store_amount").keypress(function(e){
            if( (e.keyCode || e.which) == 13 )  // ENTER
                recordSale();
        });
        $("#badge_num").keypress(function(e){
            if( (e.keyCode || e.which) == 13 )  // ENTER
                giveMerch();
        });
    });
</script>

<table>
<tr>
    <td>Record a Sale: </td>
    <td>
        <select id="what_select" onChange="showOrHideWhatText()">
            {% options STORE_ITEMS %}
            <option value="">Other...</option>
        </select>
        <input type="text" id="what_text" size="20" maxlength="50" />
    </td>
    <td> Money: $<input type="text" id="store_cash" size="2" /> </td>
    <td> MPoints: <input type="text" id="store_mpoints" size="2" /> </td>
    <td> <input type="submit" id="record_sale" value="Record Sale" onClick="recordSale()" />
</td>
<tr> <td colspan="4"> ---OR--- </td> </tr>
<tr>
    <td>Give Merch</td>
    <td> Badge Number: <input type="text" id="badge_num" size="3" /> </td>
    <td> <input type="submit" id="give_merch" value="Give" onClick="giveMerch()" />
    <td></td>
</tr>
</table>

{% endblock %}
