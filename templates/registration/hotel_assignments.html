<!doctype html>
<html ng-app="hotel">
<head>
    <title>%__department_name Hotel Rooms</title>
    <link rel="stylesheet" type="text/css" href="../static/styles.css" />
    <script src="../static/date.js" type="text/javascript"></script>
    <script src="../static/jquery-1.7.2.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.1.5/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.1.5/angular-resource.min.js"></script>
    <script type="text/javascript">
        var errorPlaceholder = function() { alert("I AM ERROR"); };
        angular.module("hotel", [])
            .factory("Hotel", function($http) {
                $http.defaults.headers.common = {"CSRF-Token": "%__CSRF_TOKEN"};
                var Hotel = {
                    lists: ["rooms", "assigned", "unassigned", "unconfirmed", "assigned_elsewhere"],
                    _set: function(dst, src) {
                        dst.splice.apply(dst, [0, dst.length].concat(src));
                    },
                    set: function(data) {
                        angular.forEach(Hotel.lists, function(name) {
                            Hotel._set(Hotel[name], data[name]);
                        });
                    },
                    get: function(id) {
                        for(var i=0, room; room=this.rooms[i]; i++) {
                            if (room.id == id) {
                                return room;
                            }
                        }
                    }
                };
                angular.forEach(Hotel.lists, function(name) {
                    Hotel[name] = [];
                });
                Hotel.set(%__dump);
                return Hotel;
            })
            .config(function($routeProvider){
                $routeProvider
                    .when('/', {controller: "HotelController", templateUrl: 'ng_templates/hotel_schedule.html'})
                    .when('/create-room', {controller: "CreateController", templateUrl: 'ng_templates/room_form.html'})
                    .when('/edit-room/:roomId', {controller: "EditController", templateUrl: 'ng_templates/room_form.html'})
                    .otherwise({redirectTo:'/'});
            })
            .controller("HotelController", function($scope, $http, Hotel) {
                $scope.department_name = "%__department_name";
                angular.forEach(Hotel.lists, function(name) {
                    $scope[name] = Hotel[name];
                });
                $scope.remove = function(attendee_id) {
                    $http({
                        method: "post",
                        url: "unassign_from_room",
                        params: {attendee_id: attendee_id}
                    }).success(Hotel.set).error(errorPlaceholder);
                };
                $scope.deleteRoom = function(room_id) {
                    $http({
                        method: "post",
                        url: "delete_room",
                        params: {id: room_id}
                    }).success(Hotel.set).error(errorPlaceholder);
                };
            })
            .controller("CreateController", function($scope, $http, $location, Hotel) {
                $scope.room = {
                    department: %__department,
                    start: %__THURSDAY,
                    end: %__SUNDAY,
                    notes: ""
                };
                $scope.save = function() {
                    $http({
                        method: "post",
                        url: "create_room",
                        params: $scope.room
                    }).success(function(response) {
                        Hotel.set(response);
                        $location.path("/");
                    }).error(errorPlaceholder);
                };
                $scope.cancel = function() {
                    $location.path("/");
                };
            })
            .controller("EditController", function($scope, $http, $location, $routeParams, Hotel) {
                $scope.room = Hotel.get($routeParams.roomId);
                $scope.save = function() {
                    $http({
                        method: "post",
                        url: "edit_room",
                        params: $scope.room
                    }).success(function(response) {
                        Hotel.set(response);
                        $location.path("/");
                    }).error(errorPlaceholder);
                };
                $scope.cancel = function() {
                    $location.path("/");
                };
            })
            .controller("AddController", function($scope, $http, Hotel) {
                $scope.assignment = {
                    room_id: $scope.room.id,
                    attendee_id: $scope.unassigned[0] && $scope.unassigned[0].id
                };
                $scope.add = function() {
                    $http({
                        method: "post",
                        url: "assign_to_room",
                        params: $scope.assignment
                    }).success(Hotel.set).error(errorPlaceholder);
                };
            })
    </script>
</head>
<body>
    <div ng-view></div>
</body>
</html>
